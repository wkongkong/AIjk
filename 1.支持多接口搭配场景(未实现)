æ‰©å±•æ”¯æŒå¤šæ¥å£æ­é…åœºæ™¯
æ–¹æ¡ˆè®¾è®¡
æ¶æ„æ‰©å±•æ€è·¯
å½“å‰æ¶æ„ï¼šå•æ¥å£æµ‹è¯•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å£Aç”¨ä¾‹   â”‚ â†’ ç‹¬ç«‹æ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å£Bç”¨ä¾‹   â”‚ â†’ ç‹¬ç«‹æ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰©å±•æ¶æ„ï¼šåœºæ™¯åŒ–æµ‹è¯•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¸šåŠ¡åœºæ™¯ç”¨ä¾‹                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚æ¥å£Aâ”‚â†’ â”‚æ¥å£Bâ”‚â†’ â”‚æ¥å£Câ”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â†“        â†“        â†“        â”‚
â”‚   æ•°æ®ä¼ é€’ + çŠ¶æ€ç®¡ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å®æ–½æ–¹æ¡ˆ
1. æ‰©å±•ç”¨ä¾‹æ•°æ®ç»“æ„
åˆ›å»ºæ–°çš„åœºæ™¯ç”¨ä¾‹æ ¼å¼ï¼š

# scenario_cases/user_registration_flow.yaml

scenario_info:
  scenario_id: "SCENARIO_001"
  scenario_name: "ç”¨æˆ·æ³¨å†Œå®Œæ•´æµç¨‹"
  description: "æµ‹è¯•ç”¨æˆ·ä»æ³¨å†Œåˆ°ç™»å½•å†åˆ°æŸ¥è¯¢ä¸ªäººä¿¡æ¯çš„å®Œæ•´æµç¨‹"
  priority: "high"
  tags:
    - "ç”¨æˆ·ç®¡ç†"
    - "ç«¯åˆ°ç«¯æµ‹è¯•"
  
test_cases:
  - test_case_id: "TC_FLOW_001"
    test_case_name: "æ­£å¸¸æ³¨å†Œç™»å½•æµç¨‹"
    test_type: "scenario"  # æ–°å¢ç±»å‹ï¼šscenario
    
    # å¤šæ­¥éª¤å®šä¹‰
    test_steps:
      # æ­¥éª¤1ï¼šæ³¨å†Œç”¨æˆ·
      - step_id: "STEP_001"
        step_name: "æ³¨å†Œæ–°ç”¨æˆ·"
        interface_id: "100001"  # å…³è”åˆ°å…·ä½“æ¥å£
        method: "POST"
        url: "/user/register"
        headers:
          Content-Type: "application/json"
        request_data:
          username: "test_user_${timestamp}"
          password: "Test@123"
          email: "test@example.com"
        expected_status_code: 200
        expected_response:
          code: "1"
          message: "æ³¨å†ŒæˆåŠŸ"
        # æ•°æ®æå–ï¼šä»å“åº”ä¸­æå–æ•°æ®ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        extract:
          - name: "user_id"
            jsonpath: "$.data.userId"
            description: "ç”¨æˆ·ID"
          - name: "username"
            jsonpath: "$.data.username"
            description: "ç”¨æˆ·å"
        # æ–­è¨€
        assertions:
          - check: "status_code"
            expected: 200
          - check: "jsonpath"
            path: "$.code"
            expected: "1"
      
      # æ­¥éª¤2ï¼šç™»å½•
      - step_id: "STEP_002"
        step_name: "ç”¨æˆ·ç™»å½•"
        interface_id: "100002"
        method: "POST"
        url: "/user/login"
        headers:
          Content-Type: "application/json"
        # ä½¿ç”¨ä¸Šä¸€æ­¥æå–çš„æ•°æ®
        request_data:
          username: "${username}"  # å¼•ç”¨STEP_001æå–çš„username
          password: "Test@123"
        expected_status_code: 200
        extract:
          - name: "token"
            jsonpath: "$.data.token"
          - name: "refresh_token"
            jsonpath: "$.data.refreshToken"
        assertions:
          - check: "status_code"
            expected: 200
          - check: "jsonpath"
            path: "$.data.token"
            operator: "exists"
      
      # æ­¥éª¤3ï¼šæŸ¥è¯¢ä¸ªäººä¿¡æ¯
      - step_id: "STEP_003"
        step_name: "æŸ¥è¯¢ä¸ªäººä¿¡æ¯"
        interface_id: "100003"
        method: "GET"
        url: "/user/profile/${user_id}"  # ä½¿ç”¨STEP_001æå–çš„user_id
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer ${token}"  # ä½¿ç”¨STEP_002æå–çš„token
        expected_status_code: 200
        assertions:
          - check: "jsonpath"
            path: "$.data.username"
            expected: "${username}"  # éªŒè¯ç”¨æˆ·åä¸€è‡´
          - check: "jsonpath"
            path: "$.data.userId"
            expected: "${user_id}"  # éªŒè¯ç”¨æˆ·IDä¸€è‡´
      
      # æ­¥éª¤4ï¼šä¿®æ”¹ä¸ªäººä¿¡æ¯
      - step_id: "STEP_004"
        step_name: "ä¿®æ”¹ä¸ªäººä¿¡æ¯"
        interface_id: "100004"
        method: "PUT"
        url: "/user/profile"
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer ${token}"
        request_data:
          userId: "${user_id}"
          nickname: "æµ‹è¯•æ˜µç§°"
          avatar: "http://example.com/avatar.jpg"
        expected_status_code: 200
        assertions:
          - check: "jsonpath"
            path: "$.code"
            expected: "1"
    
    # åœºæ™¯çº§åˆ«çš„å‰ç½®æ¡ä»¶
    preconditions:
      - "æ•°æ®åº“ä¸­ä¸å­˜åœ¨è¯¥æµ‹è¯•ç”¨æˆ·"
      - "é‚®ç®±æœåŠ¡æ­£å¸¸"
    
    # åœºæ™¯çº§åˆ«çš„åç½®æ¸…ç†
    postconditions:
      - "æ¸…ç†æµ‹è¯•ç”¨æˆ·æ•°æ®"
      - "æ¸…ç†ç›¸å…³æ—¥å¿—"
    
    # å¤±è´¥å¤„ç†ç­–ç•¥
    on_failure:
      stop_on_step_failure: true  # æŸæ­¥éª¤å¤±è´¥åˆ™åœæ­¢åç»­æ­¥éª¤
      cleanup_on_failure: true    # å¤±è´¥åæ‰§è¡Œæ¸…ç†
2. æ‰©å±•æ‰§è¡Œæ¡†æ¶
åˆ›å»ºåœºæ™¯æµ‹è¯•æ‰§è¡Œå™¨ï¼š

# 3.æ¥å£ç”¨ä¾‹è„šæœ¬æ‰§è¡Œæ¡†æ¶/api_autotest/core/scenario_executor.py

class ScenarioExecutor:
    """åœºæ™¯åŒ–æµ‹è¯•æ‰§è¡Œå™¨"""
    
    def __init__(self, api_client):
        self.api_client = api_client
        self.context = {}  # å­˜å‚¨æ­¥éª¤é—´å…±äº«çš„æ•°æ®
        
    def execute_scenario(self, scenario_case):
        """æ‰§è¡Œåœºæ™¯æµ‹è¯•ç”¨ä¾‹"""
        scenario_id = scenario_case['test_case_id']
        steps = scenario_case['test_steps']
        
        logger.info(f"å¼€å§‹æ‰§è¡Œåœºæ™¯: {scenario_case['test_case_name']}")
        
        results = {
            'scenario_id': scenario_id,
            'scenario_name': scenario_case['test_case_name'],
            'steps': [],
            'status': 'passed',
            'context': {}
        }
        
        try:
            # æ‰§è¡Œå‰ç½®æ¡ä»¶æ£€æŸ¥
            self._check_preconditions(scenario_case.get('preconditions', []))
            
            # é€æ­¥æ‰§è¡Œ
            for step in steps:
                step_result = self._execute_step(step)
                results['steps'].append(step_result)
                
                # å¦‚æœæ­¥éª¤å¤±è´¥ä¸”é…ç½®äº†åœæ­¢ç­–ç•¥
                if not step_result['passed']:
                    if scenario_case.get('on_failure', {}).get('stop_on_step_failure', True):
                        results['status'] = 'failed'
                        logger.error(f"æ­¥éª¤ {step['step_id']} å¤±è´¥ï¼Œåœæ­¢åç»­æ­¥éª¤")
                        break
            
            # æ‰§è¡Œåç½®æ¸…ç†
            self._execute_postconditions(scenario_case.get('postconditions', []))
            
        except Exception as e:
            results['status'] = 'error'
            results['error'] = str(e)
            logger.error(f"åœºæ™¯æ‰§è¡Œå¼‚å¸¸: {e}")
            
            # å¤±è´¥æ¸…ç†
            if scenario_case.get('on_failure', {}).get('cleanup_on_failure', True):
                self._cleanup_on_failure(scenario_case)
        
        return results
    
    def _execute_step(self, step):
        """æ‰§è¡Œå•ä¸ªæ­¥éª¤"""
        step_id = step['step_id']
        logger.info(f"æ‰§è¡Œæ­¥éª¤: {step_id} - {step['step_name']}")
        
        # æ›¿æ¢è¯·æ±‚æ•°æ®ä¸­çš„å˜é‡
        request_data = self._replace_variables(step.get('request_data', {}))
        url = self._replace_variables(step['url'])
        headers = self._replace_variables(step.get('headers', {}))
        
        # å‘é€è¯·æ±‚
        response = self.api_client.request(
            method=step['method'],
            url=url,
            headers=headers,
            json=request_data
        )
        
        # æå–æ•°æ®åˆ°ä¸Šä¸‹æ–‡
        if 'extract' in step:
            for extract_rule in step['extract']:
                value = self._extract_value(response.json(), extract_rule['jsonpath'])
                self.context[extract_rule['name']] = value
                logger.info(f"æå–å˜é‡: {extract_rule['name']} = {value}")
        
        # æ‰§è¡Œæ–­è¨€
        assertions_passed = True
        assertion_results = []
        
        for assertion in step.get('assertions', []):
            result = self._run_assertion(assertion, response)
            assertion_results.append(result)
            if not result['passed']:
                assertions_passed = False
        
        return {
            'step_id': step_id,
            'step_name': step['step_name'],
            'passed': assertions_passed,
            'status_code': response.status_code,
            'response_time': response.elapsed.total_seconds(),
            'assertions': assertion_results,
            'extracted_data': {k: v for k, v in self.context.items()}
        }
    
    def _replace_variables(self, data):
        """æ›¿æ¢æ•°æ®ä¸­çš„å˜é‡å¼•ç”¨"""
        if isinstance(data, str):
            # æ›¿æ¢ ${variable_name} æ ¼å¼çš„å˜é‡
            import re
            pattern = r'\$\{(\w+)\}'
            
            def replace_match(match):
                var_name = match.group(1)
                if var_name in self.context:
                    return str(self.context[var_name])
                elif var_name == 'timestamp':
                    import time
                    return str(int(time.time()))
                else:
                    logger.warning(f"å˜é‡ {var_name} æœªæ‰¾åˆ°")
                    return match.group(0)
            
            return re.sub(pattern, replace_match, data)
        
        elif isinstance(data, dict):
            return {k: self._replace_variables(v) for k, v in data.items()}
        
        elif isinstance(data, list):
            return [self._replace_variables(item) for item in data]
        
        else:
            return data
    
    def _extract_value(self, response_data, jsonpath):
        """ä½¿ç”¨JSONPathæå–æ•°æ®"""
        from jsonpath_ng import parse
        jsonpath_expr = parse(jsonpath)
        matches = jsonpath_expr.find(response_data)
        return matches[0].value if matches else None
3. æ‰©å±•conftest.pyæ”¯æŒåœºæ™¯æµ‹è¯•
# 3.æ¥å£ç”¨ä¾‹è„šæœ¬æ‰§è¡Œæ¡†æ¶/api_autotest/testcases/conftest.py

def pytest_generate_tests(metafunc):
    """åŠ¨æ€ç”Ÿæˆæµ‹è¯•å‚æ•° - æ”¯æŒå•æ¥å£å’Œåœºæ™¯æµ‹è¯•"""
    
    # åœºæ™¯æµ‹è¯•
    if "scenario_case" in metafunc.fixturenames:
        scenario_dir = os.path.join(project_root, "scenario_cases")
        scenario_cases = []
        scenario_ids = []
        
        if os.path.exists(scenario_dir):
            for file in os.listdir(scenario_dir):
                if file.endswith('.yaml'):
                    file_path = os.path.join(scenario_dir, file)
                    cases = DataHandler.load_test_cases(file_path)
                    
                    # åªåŠ è½½ test_type ä¸º scenario çš„ç”¨ä¾‹
                    for case in cases:
                        if case.get('test_type') == 'scenario':
                            scenario_cases.append(case)
                            scenario_ids.append(f"{file}::{case['test_case_id']}")
        
        if scenario_cases:
            metafunc.parametrize("scenario_case", scenario_cases, ids=scenario_ids)
    
    # åŸæœ‰çš„å•æ¥å£æµ‹è¯•é€»è¾‘ä¿æŒä¸å˜
    elif "test_case" in metafunc.fixturenames:
        # ... åŸæœ‰ä»£ç  ...
4. åˆ›å»ºåœºæ™¯æµ‹è¯•æ–‡ä»¶
# 3.æ¥å£ç”¨ä¾‹è„šæœ¬æ‰§è¡Œæ¡†æ¶/api_autotest/testcases/test_scenario.py

import pytest
import allure
from core.scenario_executor import ScenarioExecutor
from core.api_client import APIClient

@allure.feature("åœºæ™¯åŒ–æµ‹è¯•")
class TestScenario:
    """åœºæ™¯åŒ–æµ‹è¯•ç±»"""
    
    @pytest.fixture(scope="function")
    def scenario_executor(self):
        """åœºæ™¯æ‰§è¡Œå™¨fixture"""
        api_client = APIClient()
        return ScenarioExecutor(api_client)
    
    @allure.story("ä¸šåŠ¡æµç¨‹æµ‹è¯•")
    def test_scenario(self, scenario_case, scenario_executor):
        """æ‰§è¡Œåœºæ™¯æµ‹è¯•ç”¨ä¾‹"""
        
        # æ·»åŠ AllureæŠ¥å‘Šä¿¡æ¯
        allure.dynamic.title(scenario_case['test_case_name'])
        allure.dynamic.description(scenario_case.get('description', ''))
        
        # æ‰§è¡Œåœºæ™¯
        result = scenario_executor.execute_scenario(scenario_case)
        
        # ä¸ºæ¯ä¸ªæ­¥éª¤æ·»åŠ Allureæ­¥éª¤
        for step_result in result['steps']:
            with allure.step(f"{step_result['step_id']}: {step_result['step_name']}"):
                allure.attach(
                    json.dumps(step_result, indent=2, ensure_ascii=False),
                    name="æ­¥éª¤æ‰§è¡Œç»“æœ",
                    attachment_type=allure.attachment_type.JSON
                )
                
                # æ–­è¨€æ­¥éª¤é€šè¿‡
                assert step_result['passed'], f"æ­¥éª¤å¤±è´¥: {step_result['step_name']}"
        
        # æ–­è¨€æ•´ä¸ªåœºæ™¯é€šè¿‡
        assert result['status'] == 'passed', f"åœºæ™¯æµ‹è¯•å¤±è´¥"
5. AIç”Ÿæˆåœºæ™¯ç”¨ä¾‹
æ‰©å±•Difyæç¤ºè¯ï¼Œæ”¯æŒç”Ÿæˆåœºæ™¯ç”¨ä¾‹ï¼š

# 1.APIæ–‡æ¡£è§£ææœåŠ¡å¹³å°/app/dify_client.py

def generate_scenario_testcases(self, interfaces_list, scenario_description):
    """
    ç”Ÿæˆåœºæ™¯åŒ–æµ‹è¯•ç”¨ä¾‹
    
    Args:
        interfaces_list: å¤šä¸ªæ¥å£çš„ä¿¡æ¯åˆ—è¡¨
        scenario_description: åœºæ™¯æè¿°ï¼ˆç”¨æˆ·è¾“å…¥æˆ–AIæ¨æ–­ï¼‰
    """
    
    prompt = f"""
è¯·æ ¹æ®ä»¥ä¸‹æ¥å£åˆ—è¡¨ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡åœºæ™¯æµ‹è¯•ç”¨ä¾‹ã€‚

åœºæ™¯æè¿°: {scenario_description}

æ¶‰åŠçš„æ¥å£:
{json.dumps(interfaces_list, ensure_ascii=False, indent=2)}

è¦æ±‚:
1. ç”ŸæˆYAMLæ ¼å¼çš„åœºæ™¯æµ‹è¯•ç”¨ä¾‹
2. åŒ…å«å¤šä¸ªtest_stepsï¼Œæ¯ä¸ªæ­¥éª¤è°ƒç”¨ä¸€ä¸ªæ¥å£
3. æ­¥éª¤ä¹‹é—´è¦æœ‰æ•°æ®ä¼ é€’ï¼ˆä½¿ç”¨extractå’Œå˜é‡å¼•ç”¨ï¼‰
4. è€ƒè™‘çœŸå®çš„ä¸šåŠ¡æµç¨‹é¡ºåº
5. æ·»åŠ åˆç†çš„æ–­è¨€éªŒè¯

è¾“å‡ºæ ¼å¼å‚è€ƒ:
```yaml
scenario_info:
  scenario_id: "SCENARIO_XXX"
  scenario_name: "åœºæ™¯åç§°"
  
test_cases:
  - test_case_id: "TC_FLOW_XXX"
    test_type: "scenario"
    test_steps:
      - step_id: "STEP_001"
        interface_id: "xxx"
        method: "POST"
        url: "/xxx"
        request_data: {{}}
        extract:
          - name: "variable_name"
            jsonpath: "$.data.field"
      - step_id: "STEP_002"
        request_data:
          field: "${{variable_name}}"  # ä½¿ç”¨ä¸Šä¸€æ­¥çš„æ•°æ®
"""

# è°ƒç”¨Difyç”Ÿæˆ
# ...

#### **6. å‰ç«¯ç•Œé¢æ”¯æŒ**

åœ¨æ¥å£åˆ—è¡¨é¡µæ·»åŠ "åˆ›å»ºåœºæ™¯ç”¨ä¾‹"åŠŸèƒ½ï¼š

```html
<!-- åœºæ™¯ç”¨ä¾‹åˆ›å»ºç•Œé¢ -->
<div class="scenario-builder">
    <h3>ğŸ¬ åˆ›å»ºåœºæ™¯æµ‹è¯•ç”¨ä¾‹</h3>
    
    <div class="scenario-steps">
        <div class="step-item" draggable="true">
            <span class="step-number">1</span>
            <select class="interface-selector">
                <option>é€‰æ‹©æ¥å£...</option>
                <option value="100001">POST /user/register - ç”¨æˆ·æ³¨å†Œ</option>
                <option value="100002">POST /user/login - ç”¨æˆ·ç™»å½•</option>
            </select>
            <button class="btn-config">é…ç½®</button>
            <button class="btn-remove">åˆ é™¤</button>
        </div>
    </div>
    
    <button class="btn-add-step">â• æ·»åŠ æ­¥éª¤</button>
    <button class="btn-ai-generate">ğŸ¤– AIæ™ºèƒ½ç”Ÿæˆåœºæ™¯</button>
    <button class="btn-save">ğŸ’¾ ä¿å­˜åœºæ™¯ç”¨ä¾‹</button>
</div>
æ€»ç»“
å½“å‰çŠ¶æ€
âœ… å•æ¥å£æµ‹è¯•ï¼šå®Œå…¨æ”¯æŒ
âŒ å¤šæ¥å£åœºæ™¯ï¼šä¸æ”¯æŒ
æ‰©å±•åèƒ½åŠ›
âœ… å•æ¥å£ç‹¬ç«‹æµ‹è¯•
âœ… å¤šæ¥å£ç¼–æ’åœºæ™¯æµ‹è¯•
âœ… æ­¥éª¤é—´æ•°æ®ä¼ é€’
âœ… ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
âœ… AIæ™ºèƒ½ç”Ÿæˆåœºæ™¯ç”¨ä¾‹
å®æ–½ä¼˜å…ˆçº§
Phase 1: æ‰©å±•æ•°æ®ç»“æ„å’Œæ‰§è¡Œæ¡†æ¶ï¼ˆæ ¸å¿ƒèƒ½åŠ›ï¼‰
Phase 2: å‰ç«¯ç•Œé¢æ”¯æŒæ‰‹åŠ¨åˆ›å»ºåœºæ™¯
Phase 3: AIæ™ºèƒ½ç”Ÿæˆåœºæ™¯ç”¨ä¾‹