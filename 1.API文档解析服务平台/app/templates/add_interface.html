<!DOCTYPE html>
<html lang="zh-CN" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢æ¥å£ - API æ–‡æ¡£è§£ææœåŠ¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='themes.css') }}">
    <style>
        .add-interface-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .page-header h1 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .page-header p {
            margin: 0;
            color: #666;
        }

        .form-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .required-mark {
            color: #f56565;
            margin-left: 4px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .btn-large {
            padding: 12px 32px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="add-interface-container">
        <div class="page-header">
            <h1>â• æ–°å¢æ¥å£</h1>
            <p>æ‰‹åŠ¨æ·»åŠ æ¥å£ä¿¡æ¯ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</p>
        </div>

        <div class="form-card">
            <form id="addInterfaceForm" onsubmit="submitAddInterface(event)">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="section-title">ğŸ“Œ åŸºæœ¬ä¿¡æ¯</div>
                
                <div class="form-group">
                    <label>æ¥å£åç§° <span class="required-mark">*</span></label>
                    <input type="text" id="interfaceSummary" required placeholder="ä¾‹å¦‚ï¼šè·å–ç”¨æˆ·ä¿¡æ¯">
                </div>
                
                <div class="form-group">
                    <label>è¯·æ±‚æ–¹æ³• <span class="required-mark">*</span></label>
                    <select id="interfaceMethod" required>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>URLè·¯å¾„ <span class="required-mark">*</span></label>
                    <input type="text" id="interfacePath" required placeholder="ä¾‹å¦‚ï¼š/api/user/{id}">
                </div>
                
                <div class="form-group">
                    <label>æ¥å£æè¿°</label>
                    <textarea id="interfaceDescription" rows="3" placeholder="è¯¦ç»†æè¿°æ¥å£çš„åŠŸèƒ½å’Œç”¨é€”"></textarea>
                </div>
                
                <div class="form-group">
                    <label>æ ‡ç­¾ï¼ˆå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="interfaceTags" placeholder="ä¾‹å¦‚ï¼šç”¨æˆ·,æŸ¥è¯¢">
                </div>

                <!-- è¯·æ±‚å‚æ•° -->
                <div class="section-title">ğŸ“¥ è¯·æ±‚å‚æ•°</div>
                
                <div class="form-group">
                    <label>è¯·æ±‚å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea id="interfaceParameters" rows="8" placeholder='ä¾‹å¦‚ï¼š
{
  "id": {
    "type": "string",
    "required": true,
    "description": "ç”¨æˆ·ID"
  },
  "name": {
    "type": "string",
    "required": false,
    "description": "ç”¨æˆ·åç§°"
  }
}'></textarea>
                </div>
                
                <div class="form-group">
                    <label>è¯·æ±‚ä½“ï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea id="interfaceRequestBody" rows="8" placeholder='ä¾‹å¦‚ï¼š
{
  "name": "string",
  "age": "integer",
  "email": "string"
}'></textarea>
                </div>

                <!-- å“åº”ä¿¡æ¯ -->
                <div class="section-title">ğŸ“¤ å“åº”ä¿¡æ¯</div>
                
                <div class="form-group">
                    <label>å“åº”ç¤ºä¾‹ï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea id="interfaceResponses" rows="10" placeholder='ä¾‹å¦‚ï¼š
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "123",
    "name": "å¼ ä¸‰",
    "age": 25
  }
}'></textarea>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary btn-large" onclick="goBack()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary btn-large">ä¿å­˜å¹¶ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loadingText">å¤„ç†ä¸­...</p>
    </div>

    <div id="alert"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const collectionId = urlParams.get('collection_id');

        if (!collectionId) {
            alert('ç¼ºå°‘é›†åˆIDå‚æ•°');
            window.location.href = '/';
        }

        function showLoading(text) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loadingText').textContent = text || 'å¤„ç†ä¸­...';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showSuccess(message) {
            const alert = document.getElementById('alert');
            const formattedMessage = message.replace(/\n/g, '<br>');
            alert.innerHTML = `<div class="alert alert-success">${formattedMessage}</div>`;
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            setTimeout(() => alert.innerHTML = '', 10000);
        }

        function showError(message) {
            const alert = document.getElementById('alert');
            const formattedMessage = message.replace(/\n/g, '<br>');
            alert.innerHTML = `<div class="alert alert-error">${formattedMessage}</div>`;
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function goBack() {
            window.location.href = `/?show_collection=${collectionId}`;
        }

        async function submitAddInterface(event) {
            event.preventDefault();

            try {
                showLoading('æ­£åœ¨ä¿å­˜æ¥å£...');

                // æ”¶é›†è¡¨å•æ•°æ®
                const summary = document.getElementById('interfaceSummary').value.trim();
                const method = document.getElementById('interfaceMethod').value;
                const path = document.getElementById('interfacePath').value.trim();
                const description = document.getElementById('interfaceDescription').value.trim();
                const tagsInput = document.getElementById('interfaceTags').value.trim();
                const parametersInput = document.getElementById('interfaceParameters').value.trim();
                const requestBodyInput = document.getElementById('interfaceRequestBody').value.trim();
                const responsesInput = document.getElementById('interfaceResponses').value.trim();

                // è§£ææ ‡ç­¾
                const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                // è§£æJSONå­—æ®µ
                let parameters = {};
                let requestBody = {};
                let responses = {};

                if (parametersInput) {
                    try {
                        parameters = JSON.parse(parametersInput);
                    } catch (e) {
                        showError('âŒ è¯·æ±‚å‚æ•°JSONæ ¼å¼ä¸æ­£ç¡®\n\n' + e.message);
                        hideLoading();
                        return;
                    }
                }

                if (requestBodyInput) {
                    try {
                        requestBody = JSON.parse(requestBodyInput);
                    } catch (e) {
                        showError('âŒ è¯·æ±‚ä½“JSONæ ¼å¼ä¸æ­£ç¡®\n\n' + e.message);
                        hideLoading();
                        return;
                    }
                }

                if (responsesInput) {
                    try {
                        responses = JSON.parse(responsesInput);
                    } catch (e) {
                        showError('âŒ å“åº”ç¤ºä¾‹JSONæ ¼å¼ä¸æ­£ç¡®\n\n' + e.message);
                        hideLoading();
                        return;
                    }
                }

                // ç”Ÿæˆæ¥å£ID
                const interfaceId = Date.now().toString();

                // æ„å»ºæ¥å£å¯¹è±¡
                const newInterface = {
                    id: interfaceId,
                    method: method,
                    path: path,
                    summary: summary,
                    description: description,
                    tags: tags,
                    parameters: parameters,
                    requestBody: requestBody,
                    responses: responses,
                    deprecated: false
                };

                // è°ƒç”¨åç«¯APIä¿å­˜æ¥å£
                const response = await fetch(`/api/collection/${collectionId}/add-interface`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ interface: newInterface })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess('âœ… æ¥å£æ·»åŠ æˆåŠŸï¼');
                    
                    // è¯¢é—®æ˜¯å¦ç«‹å³ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
                    if (confirm('æ¥å£å·²æ·»åŠ æˆåŠŸï¼æ˜¯å¦ç«‹å³ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Ÿ')) {
                        // è·³è½¬åˆ°é¦–é¡µå¹¶è§¦å‘ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
                        window.location.href = `/?show_collection=${collectionId}&generate_interface=${interfaceId}`;
                    } else {
                        // è¿”å›æ¥å£åˆ—è¡¨
                        window.location.href = `/?show_collection=${collectionId}`;
                    }
                } else {
                    showError('âŒ æ·»åŠ æ¥å£å¤±è´¥\n\n' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ æ¥å£å¤±è´¥:', error);
                showError('âŒ æ·»åŠ æ¥å£å¤±è´¥\n\n' + error.message);
            } finally {
                hideLoading();
            }
        }
    </script>
    <script src="{{ url_for('static', filename='theme-switcher.js') }}"></script>
</body>
</html>
