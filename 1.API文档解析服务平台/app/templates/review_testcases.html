<!DOCTYPE html>
<html lang="zh-CN" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç”¨ä¾‹å®¡æ ¸ - API æ–‡æ¡£è§£ææœåŠ¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='themes.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .testcase-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .testcase-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: relative;
        }

        .testcase-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
            table-layout: fixed;
        }

        .testcase-table th,
        .testcase-table td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .testcase-table th {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 100px;
            max-width: 200px;
        }

        /* å›ºå®šç¬¬ä¸€åˆ—ï¼ˆå¤é€‰æ¡†åˆ—ï¼‰ */
        .testcase-table th:first-child,
        .testcase-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .testcase-table th:first-child {
            background: #f5f5f5;
            z-index: 30;
        }

        /* å›ºå®šç¬¬äºŒåˆ—ï¼ˆæµ‹è¯•ç”¨ä¾‹IDåˆ—ï¼‰ */
        .testcase-table th:nth-child(2),
        .testcase-table td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 15;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .testcase-table th:nth-child(2) {
            background: #f5f5f5;
            z-index: 25;
        }

        .testcase-table td {
            min-width: 120px;
            max-width: 250px;
        }

        .testcase-table tbody tr:hover {
            background: #f8f9ff;
        }

        .testcase-table tbody tr:hover td:first-child,
        .testcase-table tbody tr:hover td:nth-child(2) {
            background: #f8f9ff;
        }

        /* é¢„æœŸçŠ¶æ€ç åˆ— - è°ƒæ•´å®½åº¦ä»¥ä¸€è¡Œæ˜¾ç¤º */
        .testcase-table th:nth-child(9),
        .testcase-table td:nth-child(9) {
            min-width: 120px;
            max-width: 140px;
            white-space: nowrap;
        }

        /* å®¡æ ¸çŠ¶æ€ç›¸å…³æ ·å¼ */
        .row-approved {
            background: #e8f5e9 !important;
        }

        .row-rejected {
            background: #ffebee !important;
        }

        .row-pending {
            background: #fff !important;
        }

        .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        .testcase-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .editable-cell {
            position: relative;
        }

        .editable-cell input,
        .editable-cell textarea {
            width: 100%;
            border: 1px solid #ddd;
            padding: 6px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9em;
            box-sizing: border-box;
        }

        .editable-cell textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.4;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background: #5a6268;
        }
        
        .back-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æµ‹è¯•ç”¨ä¾‹å®¡æ ¸</h1>
            <p>æŸ¥çœ‹ã€ç¼–è¾‘å’Œå®¡æ ¸ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹</p>
        </div>

        <div class="card">
            <div class="toolbar">
                <div class="back-buttons">
                    <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
                    <a href="#" class="back-btn" onclick="goBack()">â† è¿”å›ä¸Šä¸€é¡µ</a>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æµ‹è¯•ç”¨ä¾‹...">
                    <button class="btn" onclick="filterTestCases()">æœç´¢</button>
                </div>
            </div>

            <div id="testcaseInfo" class="testcase-info">
                <div class="loading">æ­£åœ¨åŠ è½½æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯...</div>
            </div>

            <div id="alert"></div>

            <!-- æ‰¹é‡å®¡æ ¸å·¥å…·æ  -->
            <div class="action-buttons" style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="selectAllTestcases" onchange="toggleSelectAllTestcases(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                        <label for="selectAllTestcases" style="font-weight: 600; cursor: pointer;">å…¨é€‰</label>
                        <span id="selectedTestcaseCount" style="color: #666;">å·²é€‰æ‹©: 0</span>
                    </div>
                    <button class="btn btn-success" id="batchApproveBtn" onclick="batchApproveSelected()" disabled>âœ… æ‰¹é‡å®¡æ ¸é€šè¿‡</button>
                    <button class="btn btn-danger" id="batchRejectBtn" onclick="batchRejectSelected()" disabled>âŒ æ‰¹é‡å®¡æ ¸æ‹’ç»</button>
                    <button class="btn btn-danger" id="batchDeleteBtn" onclick="batchDeleteSelected()" disabled>ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="saveTestCases()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button class="btn btn-secondary" onclick="regenerateTestCases()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                <!-- <button class="btn btn-danger" onclick="clearAllTestCases()">ğŸ—‘ï¸ ä¸€é”®æ¸…é™¤å…¨éƒ¨</button> -->
                <button class="btn" onclick="downloadYAML()">ğŸ“¥ ä¸‹è½½YAMLæ–‡ä»¶</button>
                <button class="btn btn-primary" id="executeBtn" onclick="executeTestCases()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ§ª è°ƒè¯•ç”¨ä¾‹</button>
                <button class="btn" id="viewReportBtn" onclick="viewTestReport()" style="background: #ccc; cursor: not-allowed;" disabled>ğŸ“Š æŸ¥çœ‹è°ƒè¯•æŠ¥å‘Š</button>
                <button class="btn" onclick="archiveTestCase()" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">ğŸ“¦ å½’æ¡£ç”¨ä¾‹</button>
                <button class="btn btn-disabled" disabled title="åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…" style="background: #ccc; cursor: not-allowed;">ğŸ ç”ŸæˆPYè„šæœ¬ï¼ˆå¾…å¼€å‘ï¼‰</button>
            </div>
            
            <!-- æ‰§è¡Œç»“æœæç¤ºåŒºåŸŸ -->
            <div id="executionResult" style="display: none; margin: 15px 0; padding: 20px; border-radius: 10px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 5px solid #4caf50; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 36px; line-height: 1;">âœ…</div>
                    <div style="flex: 1;">
                        <div style="font-size: 1.2em; font-weight: 700; color: #2e7d32; margin-bottom: 12px;">ç”¨ä¾‹æ‰§è¡ŒæˆåŠŸ</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 0.8em; color: #666; margin-bottom: 3px;">ğŸ“… æäº¤æ—¶é—´</div>
                                <div style="font-weight: 600; color: #333;" id="executionTime"></div>
                            </div>
                            <div style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 0.8em; color: #666; margin-bottom: 3px;">ğŸ”– SVNç‰ˆæœ¬</div>
                                <div style="font-weight: 600; color: #333;" id="svnRevision"></div>
                            </div>
                            <div style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 0.8em; color: #666; margin-bottom: 3px;">ğŸ“ ç”¨ä¾‹æ•°é‡</div>
                                <div style="font-weight: 600; color: #333;" id="testcaseCount"></div>
                            </div>
                        </div>
                        <div id="executionWarning" style="display: none; margin-top: 10px; padding: 8px 12px; background: #fff3cd; border-radius: 4px; font-size: 0.85em; color: #856404;">
                            âš ï¸ <span id="executionWarningText"></span>
                        </div>
                        <div id="executionSteps" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid #17a2b8;">
                            <div style="font-weight: 600; color: #17a2b8; margin-bottom: 10px;">æ‰§è¡Œè¿›åº¦</div>
                            <div id="stepList" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- æ­¥éª¤å°†åŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>
                    <button onclick="closeExecutionResult()" style="background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;" title="å…³é—­">âœ•</button>
                </div>
            </div>

            <div class="table-container">
                <div id="loading" class="loading">æ­£åœ¨åŠ è½½æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼...</div>
                <table id="testcaseTable" class="testcase-table" style="display: none;">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">é€‰æ‹©</th>
                            <th style="width: 100px;">ç”¨ä¾‹ID</th>
                            <th style="width: 150px;">ç”¨ä¾‹åç§°</th>
                            <th style="width: 120px;">æ¥å£åç§°</th>
                            <th style="width: 80px;">è¯·æ±‚æ–¹æ³•</th>
                            <th style="width: 200px;">URLè·¯å¾„</th>
                            <th style="width: 200px;">è¯·æ±‚å¤´</th>
                            <th style="width: 200px;">è¯·æ±‚å‚æ•°</th>
                            <th style="width: 120px;">é¢„æœŸçŠ¶æ€ç </th>
                            <th style="width: 200px;">é¢„æœŸå“åº”</th>
                            <th style="width: 120px;">æµ‹è¯•ç±»å‹</th>
                            <th style="width: 80px;">ä¼˜å…ˆçº§</th>
                            <th style="width: 150px;">æµ‹è¯•æè¿°</th>
                            <th style="width: 150px;">å‰ç½®æ¡ä»¶</th>
                            <th style="width: 150px;">åç½®æ¡ä»¶</th>
                            <th style="width: 100px;">æ ‡ç­¾</th>
                            <th style="width: 100px;">å®¡æ ¸çŠ¶æ€</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="testcaseBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentTestCases = [];
        let originalTestCases = [];
        let currentCollectionId = '';
        let currentInterfaceId = '';
        let currentPythonCode = ''; // å­˜å‚¨ç”Ÿæˆçš„Pythonä»£ç 
        let currentBuildNumber = null; // å­˜å‚¨Jenkinsæ„å»ºå·
        let currentIsDebug = true; // å­˜å‚¨æ˜¯å¦ä¸ºè°ƒè¯•æ¨¡å¼

        // é¡µé¢åŠ è½½æ—¶ä»URLå‚æ•°è·å–æ•°æ®æˆ–ä»æœåŠ¡å™¨åŠ è½½å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const jsonContent = urlParams.get('json_content');
            const collectionId = urlParams.get('collection_id');
            const interfaceId = urlParams.get('interface_id');

            console.log('URLå‚æ•°æ£€æŸ¥:', {
                collectionId,
                interfaceId,
                jsonContentLength: jsonContent ? jsonContent.length : 0
            });

            if (collectionId && interfaceId) {
                currentCollectionId = collectionId;
                currentInterfaceId = interfaceId;
                
                if (jsonContent) {
                    try {
                        // ä»URLå‚æ•°åŠ è½½æ–°ç”Ÿæˆçš„JSONæ ¼å¼æµ‹è¯•ç”¨ä¾‹
                        const decodedJSON = decodeURIComponent(jsonContent);
                        console.log('è§£ç åçš„JSONé•¿åº¦:', decodedJSON.length);
                        console.log('JSONå‰100å­—ç¬¦:', decodedJSON.substring(0, 100));
                        
                        loadTestCasesFromJSON(decodedJSON);
                    } catch (error) {
                        console.error('JSONè§£ç å¤±è´¥:', error);
                        showError('JSONå†…å®¹è§£ç å¤±è´¥: ' + error.message);
                        // å°è¯•ä»æœåŠ¡å™¨åŠ è½½å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        await loadSavedTestCases(collectionId, interfaceId);
                    }
                } else {
                    console.log('æœªæ‰¾åˆ°JSONå†…å®¹ï¼Œä»æœåŠ¡å™¨åŠ è½½å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹');
                    // ä»æœåŠ¡å™¨åŠ è½½å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹
                    await loadSavedTestCases(collectionId, interfaceId);
                }
                
                loadInterfaceInfo(collectionId, interfaceId);
            } else {
                showError('ç¼ºå°‘å¿…è¦çš„å‚æ•°ï¼Œæ— æ³•åŠ è½½æµ‹è¯•ç”¨ä¾‹');
            }
        });

        async function loadSavedTestCases(collectionId, interfaceId) {
            try {
                const response = await fetch(`/api/testcase-status?collection_id=${collectionId}&interface_id=${interfaceId}`);
                const data = await response.json();

                if (response.ok && data.has_testcase) {
                    // ä»æœåŠ¡å™¨åŠ è½½å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹
                    const testcaseResponse = await fetch(`/api/testcase?collection_id=${collectionId}&interface_id=${interfaceId}`);
                    const testcaseData = await testcaseResponse.json();
                    
                    if (testcaseResponse.ok) {
                        // åªæ”¯æŒJSONæ ¼å¼
                        if (testcaseData.testcase.json_content && testcaseData.testcase.json_content.trim()) {
                            loadTestCasesFromJSON(testcaseData.testcase.json_content);
                            showSuccess('å·²åŠ è½½å·²ä¿å­˜çš„JSONæ ¼å¼æµ‹è¯•ç”¨ä¾‹');
                        } else {
                            showError('æµ‹è¯•ç”¨ä¾‹å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ”¯æŒ');
                        }
                    } else {
                        showError('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥: ' + testcaseData.error);
                    }
                } else {
                    showError('è¯¥æ¥å£æš‚æ— å·²ä¿å­˜çš„æµ‹è¯•ç”¨ä¾‹');
                }
            } catch (error) {
                console.error('åŠ è½½å·²ä¿å­˜æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                showError('åŠ è½½å·²ä¿å­˜æµ‹è¯•ç”¨ä¾‹å¤±è´¥: ' + error.message);
            }
        }

        async function loadInterfaceInfo(collectionId, interfaceId) {
            try {
                console.log('å¼€å§‹åŠ è½½æ¥å£ä¿¡æ¯:', { collectionId, interfaceId });
                const response = await fetch(`/api/interface/${collectionId}/${interfaceId}`);
                
                console.log('æ¥å£ä¿¡æ¯å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('æ¥å£ä¿¡æ¯:', data);
                    
                    const iface = data.interface;
                    document.getElementById('testcaseInfo').innerHTML = `
                        <h3>${iface.summary || 'æ¥å£è¯¦æƒ…'}</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">æ¥å£ID</div>
                                <div class="info-value">${interfaceId}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">è¯·æ±‚æ–¹æ³•</div>
                                <div class="info-value">${iface.method}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">URLè·¯å¾„</div>
                                <div class="info-value">${iface.path}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">é›†åˆID</div>
                                <div class="info-value">${collectionId}</div>
                            </div>
                        </div>
                    `;
                    
                    console.log('æ¥å£ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ');
                } else {
                    const errorText = await response.text();
                    console.error('æ¥å£ä¿¡æ¯åŠ è½½å¤±è´¥:', response.status, errorText);
                    showError('åŠ è½½æ¥å£ä¿¡æ¯å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                console.error('åŠ è½½æ¥å£ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showError('åŠ è½½æ¥å£ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }

        function loadTestCasesFromJSON(jsonContent) {
            console.log('å¼€å§‹è§£æJSONå†…å®¹ï¼Œæ€»é•¿åº¦:', jsonContent.length);
            console.log('JSONå†…å®¹é¢„è§ˆ:', jsonContent.substring(0, 200));
            
            try {
                const data = JSON.parse(jsonContent);
                console.log('JSONè§£æç»“æœ:', data);
                
                // æ”¯æŒå¤šç§JSONæ ¼å¼
                let testCasesArray = [];
                
                if (Array.isArray(data)) {
                    // ç›´æ¥æ˜¯æ•°ç»„æ ¼å¼
                    testCasesArray = data;
                    console.log('æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼çš„æµ‹è¯•ç”¨ä¾‹');
                } else if (data && typeof data === 'object' && data.test_cases) {
                    // åŒ…å«test_caseså­—æ®µçš„å¯¹è±¡æ ¼å¼
                    testCasesArray = data.test_cases;
                    console.log('æ£€æµ‹åˆ°åŒ…å«test_caseså­—æ®µçš„å¯¹è±¡æ ¼å¼');
                } else if (data && typeof data === 'object' && data.testcases) {
                    // åŒ…å«testcaseså­—æ®µçš„å¯¹è±¡æ ¼å¼
                    testCasesArray = data.testcases;
                    console.log('æ£€æµ‹åˆ°åŒ…å«testcaseså­—æ®µçš„å¯¹è±¡æ ¼å¼');
                } else if (data && typeof data === 'object') {
                    // å•ä¸ªæµ‹è¯•ç”¨ä¾‹å¯¹è±¡
                    testCasesArray = [data];
                    console.log('æ£€æµ‹åˆ°å•ä¸ªæµ‹è¯•ç”¨ä¾‹å¯¹è±¡æ ¼å¼');
                } else {
                    showError('JSONæ ¼å¼ä¸æ­£ç¡®ï¼ŒæœŸæœ›æ•°ç»„æˆ–åŒ…å«test_cases/testcaseså­—æ®µçš„å¯¹è±¡');
                    return;
                }
                
                currentTestCases = testCasesArray.map((testCase, index) => {
                    // æ ‡å‡†åŒ–æµ‹è¯•ç”¨ä¾‹å­—æ®µ
                    return {
                        test_case_id: testCase.test_case_id || testCase.id || `test_${index + 1}`,
                        test_case_name: testCase.test_case_name || testCase.name || `æµ‹è¯•ç”¨ä¾‹ ${index + 1}`,
                        api_name: testCase.api_name || testCase.apiName || '',
                        method: testCase.method || '',
                        url: testCase.url || testCase.path || '',
                        headers: testCase.headers || testCase.request_headers || '',
                        request_data: testCase.request_data || testCase.requestData || testCase.parameters || '',
                        expected_status_code: testCase.expected_status_code || testCase.expectedStatusCode || 200,
                        expected_response: testCase.expected_response || testCase.expectedResponse || '',
                        test_type: testCase.test_type || testCase.testType || 'åŠŸèƒ½æµ‹è¯•',
                        description: testCase.description || testCase.desc || '',
                        tags: testCase.tags || '',
                        priority: testCase.priority || 'ä¸­',
                        preconditions: testCase.preconditions || testCase.preConditions || '',
                        postconditions: testCase.postconditions || testCase.postConditions || '',
                        status: 'pending', // é»˜è®¤çŠ¶æ€ä¸ºå¾…å®¡æ ¸
                        id: index // ä¸´æ—¶ID
                    };
                });
                
                console.log(`æˆåŠŸè§£æ ${currentTestCases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
                console.log('æµ‹è¯•ç”¨ä¾‹æ•°æ®:', currentTestCases);
                
                if (currentTestCases.length === 0) {
                    showError('æœªèƒ½è§£æå‡ºä»»ä½•æµ‹è¯•ç”¨ä¾‹ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼');
                    return;
                }
                
                originalTestCases = JSON.parse(JSON.stringify(currentTestCases));
                displayTestCases();
                
            } catch (error) {
                console.error('JSONè§£æå¤±è´¥:', error);
                showError('è§£æJSONå¤±è´¥: ' + error.message);
            }
        }

        function loadTestCasesFromYAML(yamlContent) {
            console.log('å¼€å§‹è§£æYAMLå†…å®¹ï¼Œæ€»é•¿åº¦:', yamlContent.length);
            console.log('YAMLå†…å®¹é¢„è§ˆ:', yamlContent.substring(0, 200));
            
            try {
                const lines = yamlContent.trim().split('\n');
                console.log('YAMLè¡Œæ•°:', lines.length);
                
                if (lines.length < 2) {
                    showError('YAMLå†…å®¹æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦åŒ…å«æ ‡é¢˜è¡Œå’Œæ•°æ®è¡Œ');
                    console.error('YAMLè¡Œæ•°ä¸è¶³:', lines.length);
                    return;
                }
                
                const headers = parseYAMLLine(lines[0]);
                console.log('YAMLæ ‡é¢˜:', headers);
                
                currentTestCases = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        console.log(`è§£æç¬¬${i}è¡Œ:`, line);
                        const values = parseYAMLLine(line);
                        console.log(`è§£æç»“æœ:`, values);
                        
                        if (values.length === headers.length) {
                            const testCase = {};
                            headers.forEach((header, index) => {
                                testCase[header] = values[index] || '';
                            });
                            testCase.status = 'pending'; // é»˜è®¤çŠ¶æ€ä¸ºå¾…å®¡æ ¸
                            testCase.id = i; // ä¸´æ—¶ID
                            currentTestCases.push(testCase);
                        } else {
                            console.warn(`ç¬¬${i}è¡Œåˆ—æ•°ä¸åŒ¹é…: æœŸæœ›${headers.length}åˆ—ï¼Œå®é™…${values.length}åˆ—`);
                        }
                    }
                }
                
                console.log(`æˆåŠŸè§£æ ${currentTestCases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
                console.log('æµ‹è¯•ç”¨ä¾‹æ•°æ®:', currentTestCases);
                
                if (currentTestCases.length === 0) {
                    showError('æœªèƒ½è§£æå‡ºä»»ä½•æµ‹è¯•ç”¨ä¾‹ï¼Œè¯·æ£€æŸ¥YAMLæ ¼å¼');
                    return;
                }
                
                originalTestCases = JSON.parse(JSON.stringify(currentTestCases));
                displayTestCases();
                
            } catch (error) {
                console.error('YAMLè§£æå¤±è´¥:', error);
                showError('è§£æYAMLå¤±è´¥: ' + error.message);
            }
        }



        // æ ¼å¼åŒ–JSONå¯¹è±¡ä¸ºå¯è¯»å­—ç¬¦ä¸²
        function formatJSONField(value) {
            if (!value) return '';
            
            // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸ºJSON
            if (typeof value === 'string') {
                try {
                    const parsed = JSON.parse(value);
                    return JSON.stringify(parsed, null, 2);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
                    return value;
                }
            }
            
            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥æ ¼å¼åŒ–ä¸ºJSONå­—ç¬¦ä¸²
            if (typeof value === 'object') {
                return JSON.stringify(value, null, 2);
            }
            
            return String(value);
        }

        function displayTestCases() {
            const tbody = document.getElementById('testcaseBody');
            const table = document.getElementById('testcaseTable');
            const loading = document.getElementById('loading');

            if (currentTestCases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" style="text-align: center; color: #999;">æš‚æ— æµ‹è¯•ç”¨ä¾‹æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = currentTestCases.map((testCase, index) => {
                const statusClass = `status-${testCase.status}`;
                const rowClass = `row-${testCase.status}`;
                const statusText = {
                    'pending': 'å¾…å®¡æ ¸',
                    'approved': 'å·²é€šè¿‡',
                    'rejected': 'å·²æ‹’ç»'
                }[testCase.status] || 'å¾…å®¡æ ¸';
                
                // å®¡æ ¸é€šè¿‡çš„ç”¨ä¾‹ä¸èƒ½åˆ é™¤
                const canDelete = testCase.status !== 'approved';
                const deleteDisabled = !canDelete ? 'disabled' : '';
                const deleteStyle = !canDelete ? 'opacity: 0.5; cursor: not-allowed;' : '';

                return `
                    <tr class="${rowClass}" data-index="${index}" data-status="${testCase.status}">
                            <td class="checkbox-cell">
                                <input type="checkbox" class="testcase-checkbox" data-index="${index}" onchange="updateBatchTestcaseButtons()">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.test_case_id || ''}" 
                                       onchange="updateTestCase(${index}, 'test_case_id', this.value)">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.test_case_name || ''}" 
                                       onchange="updateTestCase(${index}, 'test_case_name', this.value)">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.api_name || ''}" 
                                       onchange="updateTestCase(${index}, 'api_name', this.value)">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.method || ''}" 
                                       onchange="updateTestCase(${index}, 'method', this.value)">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.url || ''}" 
                                       onchange="updateTestCase(${index}, 'url', this.value)">
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'headers', this.value)">${formatJSONField(testCase.headers)}</textarea>
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'request_data', this.value)">${formatJSONField(testCase.request_data)}</textarea>
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.expected_status_code || ''}" 
                                       onchange="updateTestCase(${index}, 'expected_status_code', this.value)">
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'expected_response', this.value)">${formatJSONField(testCase.expected_response)}</textarea>
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.test_type || ''}" 
                                       onchange="updateTestCase(${index}, 'test_type', this.value)">
                            </td>
                            <td class="editable-cell">
                                <input type="text" value="${testCase.priority || ''}" 
                                       onchange="updateTestCase(${index}, 'priority', this.value)">
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'description', this.value)">${testCase.description || ''}</textarea>
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'preconditions', this.value)">${testCase.preconditions || ''}</textarea>
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'postconditions', this.value)">${testCase.postconditions || ''}</textarea>
                            </td>
                            <td class="editable-cell">
                                <textarea onchange="updateTestCase(${index}, 'tags', this.value)">${formatJSONField(testCase.tags)}</textarea>
                            </td>
                            <td>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteTestCase(${index})" ${deleteDisabled} style="padding: 4px 8px; font-size: 0.8em; background-color: #dc3545; border-color: #dc3545; color: white; ${deleteStyle}">ğŸ—‘ï¸ åˆ é™¤</button>
                            </td>
                        </tr>
                `;
            }).join('');

            loading.style.display = 'none';
            table.style.display = 'table';
            updateBatchTestcaseButtons();
        }

        function updateTestCase(index, field, value) {
            currentTestCases[index][field] = value;
        }

        async function deleteTestCase(index) {
            const testCase = currentTestCases[index];
            
            // å®¡æ ¸é€šè¿‡çš„ç”¨ä¾‹ä¸èƒ½åˆ é™¤
            if (testCase.status === 'approved') {
                showError('âŒ å®¡æ ¸é€šè¿‡çš„æµ‹è¯•ç”¨ä¾‹ä¸èƒ½åˆ é™¤');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å—ï¼Ÿåˆ é™¤åå°†è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚')) {
                currentTestCases.splice(index, 1);
                displayTestCases();
                
                // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
                try {
                    const response = await fetch('/api/save-testcases', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            collection_id: currentCollectionId,
                            interface_id: currentInterfaceId,
                            testcases: currentTestCases
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showSuccess('æµ‹è¯•ç”¨ä¾‹å·²åˆ é™¤å¹¶æˆåŠŸä¿å­˜åˆ°æœåŠ¡å™¨');
                    } else {
                        showError('åˆ é™¤æˆåŠŸï¼Œä½†ä¿å­˜å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    showError('åˆ é™¤æˆåŠŸï¼Œä½†ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }
        }

        async function saveTestCases() {
            try {
                // ä¿å­˜æµ‹è¯•ç”¨ä¾‹åˆ°æœåŠ¡å™¨
                const response = await fetch('/api/save-testcases', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        collection_id: currentCollectionId,
                        interface_id: currentInterfaceId,
                        testcases: currentTestCases
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('æµ‹è¯•ç”¨ä¾‹å·²æˆåŠŸä¿å­˜åˆ°æœåŠ¡å™¨');
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function regenerateTestCases() {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å—ï¼Ÿæ–°ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹å°†è¿½åŠ åˆ°ç°æœ‰ç”¨ä¾‹ä¸‹æ–¹ï¼Œç”¨ä¾‹ç¼–ç è‡ªåŠ¨é€’å¢ã€‚')) {
                return;
            }

            try {
                showLoading('æ­£åœ¨é‡æ–°ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹...');
                
                const response = await fetch(`/api/generate-json/${currentCollectionId}/${currentInterfaceId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.json_content) {
                        // è§£ææ–°ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹
                        const newTestCases = parseJSONTestCases(data.json_content);
                        
                        if (newTestCases && newTestCases.length > 0) {
                            // è·å–å½“å‰æœ€å¤§çš„æµ‹è¯•ç”¨ä¾‹ç¼–å·
                            const maxId = getMaxTestCaseId();
                            
                            // ä¸ºæ–°æµ‹è¯•ç”¨ä¾‹åˆ†é…é€’å¢çš„ç¼–å·å’Œå”¯ä¸€åç§°
                            newTestCases.forEach((testCase, index) => {
                                const newId = maxId + index + 1;
                                testCase.test_case_id = `TC${String(newId).padStart(3, '0')}`;
                                
                                // ç”Ÿæˆå”¯ä¸€çš„æµ‹è¯•ç”¨ä¾‹åç§°
                                testCase.test_case_name = generateUniqueTestCaseName(testCase.test_case_name || `æµ‹è¯•ç”¨ä¾‹ ${newId}`);
                            });
                            
                            // è¿½åŠ åˆ°ç°æœ‰æµ‹è¯•ç”¨ä¾‹
                            currentTestCases = currentTestCases.concat(newTestCases);
                            displayTestCases();
                            
                            // è‡ªåŠ¨ä¿å­˜
                            await saveTestCases();
                            
                            showSuccess(`âœ… æˆåŠŸè¿½åŠ  ${newTestCases.length} ä¸ªæ–°æµ‹è¯•ç”¨ä¾‹ï¼Œç”¨ä¾‹ç¼–ç å·²è‡ªåŠ¨é€’å¢`);
                        } else {
                            showError('æœªèƒ½è§£æå‡ºæ–°çš„æµ‹è¯•ç”¨ä¾‹');
                        }
                    } else if (data.yaml_content) {
                        // å‘åå…¼å®¹ï¼šå¦‚æœAPIä»ç„¶è¿”å›YAMLå†…å®¹
                        loadTestCasesFromYAML(data.yaml_content);
                        showSuccess('æµ‹è¯•ç”¨ä¾‹é‡æ–°ç”ŸæˆæˆåŠŸï¼ˆYAMLæ ¼å¼ï¼‰');
                    } else {
                        showError('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼šæœªè¿”å›æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹å†…å®¹');
                    }
                } else {
                    showError('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        // è§£æJSONæµ‹è¯•ç”¨ä¾‹ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
        function parseJSONTestCases(jsonContent) {
            try {
                const data = JSON.parse(jsonContent);
                let testCasesArray = [];
                
                if (Array.isArray(data)) {
                    testCasesArray = data;
                } else if (data && typeof data === 'object' && data.test_cases) {
                    testCasesArray = data.test_cases;
                } else if (data && typeof data === 'object' && data.testcases) {
                    testCasesArray = data.testcases;
                } else if (data && typeof data === 'object') {
                    testCasesArray = [data];
                }
                
                return testCasesArray.map((testCase, index) => ({
                    test_case_id: testCase.test_case_id || testCase.id || `test_${index + 1}`,
                    test_case_name: testCase.test_case_name || testCase.name || `æµ‹è¯•ç”¨ä¾‹ ${index + 1}`,
                    api_name: testCase.api_name || testCase.apiName || '',
                    method: testCase.method || '',
                    url: testCase.url || testCase.path || '',
                    headers: testCase.headers || testCase.request_headers || '',
                    request_data: testCase.request_data || testCase.requestData || testCase.parameters || '',
                    expected_status_code: testCase.expected_status_code || testCase.expectedStatusCode || 200,
                    expected_response: testCase.expected_response || testCase.expectedResponse || '',
                    test_type: testCase.test_type || testCase.testType || 'åŠŸèƒ½æµ‹è¯•',
                    description: testCase.description || testCase.desc || '',
                    tags: testCase.tags || '',
                    priority: testCase.priority || 'ä¸­',
                    preconditions: testCase.preconditions || testCase.preConditions || '',
                    postconditions: testCase.postconditions || testCase.postConditions || '',
                    status: 'pending',
                    id: index
                }));
            } catch (error) {
                console.error('è§£æJSONæµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                return [];
            }
        }
        
        // è·å–å½“å‰æœ€å¤§çš„æµ‹è¯•ç”¨ä¾‹ç¼–å·
        function getMaxTestCaseId() {
            if (currentTestCases.length === 0) return 0;
            
            let maxId = 0;
            currentTestCases.forEach(testCase => {
                const id = testCase.test_case_id || '';
                // æå–æ•°å­—éƒ¨åˆ†ï¼Œä¾‹å¦‚ TC001 -> 1
                const match = id.match(/\d+/);
                if (match) {
                    const num = parseInt(match[0], 10);
                    if (num > maxId) maxId = num;
                }
            });
            
            return maxId;
        }
        
        // ç”Ÿæˆå”¯ä¸€çš„æµ‹è¯•ç”¨ä¾‹åç§°
        function generateUniqueTestCaseName(baseName) {
            // æ£€æŸ¥åŸºç¡€åç§°æ˜¯å¦å·²å­˜åœ¨
            const existingNames = currentTestCases.map(tc => tc.test_case_name);
            
            // å¦‚æœåç§°ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if (!existingNames.includes(baseName)) {
                return baseName;
            }
            
            // å¦‚æœåç§°å·²å­˜åœ¨ï¼Œå°è¯•æ·»åŠ æ•°å­—åç¼€
            let counter = 1;
            let newName = `${baseName}${counter}`;
            
            // æŒç»­é€’å¢ç›´åˆ°æ‰¾åˆ°ä¸é‡å¤çš„åç§°
            while (existingNames.includes(newName)) {
                counter++;
                newName = `${baseName}${counter}`;
            }
            
            console.log(`[åç§°å»é‡] åŸåç§° "${baseName}" å·²å­˜åœ¨ï¼Œç”Ÿæˆæ–°åç§° "${newName}"`);
            return newName;
        }
        
        // ä¸€é”®æ¸…é™¤å…¨éƒ¨æµ‹è¯•ç”¨ä¾‹
        async function clearAllTestCases() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å®¡æ ¸é€šè¿‡çš„ç”¨ä¾‹
            const approvedCount = currentTestCases.filter(tc => tc.status === 'approved').length;
            if (approvedCount > 0) {
                showError(`âŒ æœ‰ ${approvedCount} ä¸ªå®¡æ ¸é€šè¿‡çš„æµ‹è¯•ç”¨ä¾‹ä¸èƒ½æ¸…é™¤ï¼Œè¯·å…ˆå°†å…¶çŠ¶æ€æ”¹ä¸ºå¾…å®¡æ ¸æˆ–å·²æ‹’ç»`);
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å—ï¼Ÿæ­¤æ“ä½œå°†ä¿ç•™ä¸€æ¡é»˜è®¤æ•°æ®ï¼Œæ‰€æœ‰å­—æ®µä¸ºé»˜è®¤å€¼ã€‚')) {
                return;
            }
            
            // åˆ›å»ºä¸€æ¡é»˜è®¤æµ‹è¯•ç”¨ä¾‹
            const defaultTestCase = {
                test_case_id: 'TC001',
                test_case_name: 'é»˜è®¤æµ‹è¯•ç”¨ä¾‹',
                api_name: '',
                method: 'GET',
                url: '',
                headers: '{}',
                request_data: '{}',
                expected_status_code: 200,
                expected_response: '{}',
                test_type: 'åŠŸèƒ½æµ‹è¯•',
                description: 'é»˜è®¤æµ‹è¯•ç”¨ä¾‹æè¿°',
                tags: '',
                priority: 'ä¸­',
                preconditions: '',
                postconditions: '',
                status: 'pending',
                id: 0
            };
            
            currentTestCases = [defaultTestCase];
            displayTestCases();
            
            // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨
            try {
                await saveTestCases();
                showSuccess('âœ… å·²æ¸…é™¤æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œä¿ç•™ä¸€æ¡é»˜è®¤æ•°æ®');
            } catch (error) {
                showError('æ¸…é™¤æˆåŠŸï¼Œä½†ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ========== æ‰¹é‡å®¡æ ¸åŠŸèƒ½ ==========
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰æµ‹è¯•ç”¨ä¾‹
        function toggleSelectAllTestcases(checked) {
            const checkboxes = document.querySelectorAll('.testcase-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateBatchTestcaseButtons();
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
        function updateBatchTestcaseButtons() {
            const checkboxes = document.querySelectorAll('.testcase-checkbox:checked');
            const count = checkboxes.length;
            const selectedCountSpan = document.getElementById('selectedTestcaseCount');
            const batchApproveBtn = document.getElementById('batchApproveBtn');
            const batchRejectBtn = document.getElementById('batchRejectBtn');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllTestcases');
            
            if (selectedCountSpan) {
                selectedCountSpan.textContent = `å·²é€‰æ‹©: ${count}`;
            }
            
            if (batchApproveBtn) {
                batchApproveBtn.disabled = count === 0;
            }
            
            if (batchRejectBtn) {
                batchRejectBtn.disabled = count === 0;
            }
            
            if (batchDeleteBtn) {
                batchDeleteBtn.disabled = count === 0;
            }
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            if (selectAllCheckbox) {
                const allCheckboxes = document.querySelectorAll('.testcase-checkbox');
                selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
                selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
            }
        }

        // æ‰¹é‡å®¡æ ¸é€šè¿‡
        async function batchApproveSelected() {
            const checkboxes = document.querySelectorAll('.testcase-checkbox:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            if (indices.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå®¡æ ¸é€šè¿‡å—ï¼Ÿ`)) {
                return;
            }
            
            indices.forEach(index => {
                currentTestCases[index].status = 'approved';
            });
            
            displayTestCases();
            await saveTestCases();
            showSuccess(`âœ… å·²å°† ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå®¡æ ¸é€šè¿‡`);
        }

        // æ‰¹é‡å®¡æ ¸æ‹’ç»
        async function batchRejectSelected() {
            const checkboxes = document.querySelectorAll('.testcase-checkbox:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            if (indices.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå®¡æ ¸æ‹’ç»å—ï¼Ÿ`)) {
                return;
            }
            
            indices.forEach(index => {
                currentTestCases[index].status = 'rejected';
            });
            
            displayTestCases();
            await saveTestCases();
            showSuccess(`âœ… å·²å°† ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹æ ‡è®°ä¸ºå®¡æ ¸æ‹’ç»`);
        }

        // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„æµ‹è¯•ç”¨ä¾‹
        async function batchDeleteSelected() {
            const checkboxes = document.querySelectorAll('.testcase-checkbox:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            if (indices.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å®¡æ ¸é€šè¿‡çš„ç”¨ä¾‹
            const approvedIndices = indices.filter(index => currentTestCases[index].status === 'approved');
            if (approvedIndices.length > 0) {
                showError(`âŒ é€‰ä¸­çš„æµ‹è¯•ç”¨ä¾‹ä¸­æœ‰ ${approvedIndices.length} ä¸ªå·²å®¡æ ¸é€šè¿‡ï¼Œä¸èƒ½åˆ é™¤`);
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            // æŒ‰ç´¢å¼•ä»å¤§åˆ°å°æ’åºï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•é”™ä¹±
            indices.sort((a, b) => b - a);
            indices.forEach(index => {
                currentTestCases.splice(index, 1);
            });
            
            displayTestCases();
            await saveTestCases();
            showSuccess(`âœ… å·²åˆ é™¤ ${indices.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
        }

        async function downloadYAML() {
            try {
                // å°†æµ‹è¯•ç”¨ä¾‹è½¬æ¢ä¸ºYAMLæ ¼å¼
                const yamlContent = convertToYAML(currentTestCases);
                
                if (!yamlContent) {
                    showError('æ— æ³•ç”ŸæˆYAMLå†…å®¹ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸ºç©º');
                    return;
                }
                
                // è°ƒç”¨åç«¯APIä¸‹è½½YAMLæ–‡ä»¶
                const response = await fetch('/api/download-yaml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        yaml_content: yamlContent,
                        filename: `test_cases_${currentInterfaceId}_${new Date().getTime()}.yaml`
                    })
                });
                
                if (response.ok) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `test_cases_${currentInterfaceId}_${new Date().getTime()}.yaml`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('YAMLæ–‡ä»¶ä¸‹è½½æˆåŠŸ');
                } else {
                    const errorData = await response.json();
                    showError('ä¸‹è½½YAMLæ–‡ä»¶å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'));
                }
            } catch (error) {
                showError('ä¸‹è½½YAMLæ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // ========== ç”¨ä¾‹æ‰§è¡Œå’ŒæŠ¥å‘ŠæŸ¥çœ‹åŠŸèƒ½ ==========
        
        // æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ˆæäº¤åˆ°SVNå¹¶æ‰§è¡Œï¼‰
        async function executeTestCases() {
            if (currentTestCases.length === 0) {
                showError('æ²¡æœ‰æµ‹è¯•ç”¨ä¾‹å¯æ‰§è¡Œ');
                return;
            }
            
            const confirmMessage = `
ğŸ§ª ç¡®å®šè¦è°ƒè¯•å½“å‰ç”¨ä¾‹å—ï¼Ÿ

ğŸ“Š è°ƒè¯•ä¿¡æ¯ï¼š
   â€¢ ç”¨ä¾‹æ•°é‡ï¼š${currentTestCases.length} ä¸ª
   â€¢ æ‰§è¡Œç¯å¢ƒï¼šè°ƒè¯•ç¯å¢ƒ
   â€¢ SVNè·¯å¾„ï¼šsvn://172.16.9.XXX/repo/jiaoben/jk/data_yaml_debug
   â€¢ Jenkins Jobï¼šAI-jk-debug

ğŸ“ æ“ä½œæµç¨‹ï¼š
   1. ç”ŸæˆYAMLæµ‹è¯•ç”¨ä¾‹æ–‡ä»¶
   2. æäº¤åˆ°è°ƒè¯•SVNç›®å½•
   3. è§¦å‘Jenkinsè°ƒè¯•ä»»åŠ¡

ğŸ’¡ æç¤ºï¼šè°ƒè¯•é€šè¿‡åï¼Œå¯ç‚¹å‡»"å½’æ¡£ç”¨ä¾‹"æäº¤åˆ°æ­£å¼ç¯å¢ƒ
            `.trim();
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // æ¸…ç©ºä¹‹å‰çš„æ­¥éª¤
                clearExecutionSteps();
                
                // ç¦ç”¨æŸ¥çœ‹æŠ¥å‘ŠæŒ‰é’®
                disableViewReportButton();
                
                showLoading('æ­£åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹...');
                
                // å°†æµ‹è¯•ç”¨ä¾‹è½¬æ¢ä¸ºYAMLæ ¼å¼
                const yamlContent = convertToYAML(currentTestCases);
                
                if (!yamlContent) {
                    showError('æ— æ³•ç”ŸæˆYAMLå†…å®¹ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸ºç©º');
                    return;
                }
                
                // è°ƒç”¨åç«¯APIæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
                const response = await fetch('/api/execute-testcases', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        collection_id: currentCollectionId,
                        interface_id: currentInterfaceId,
                        yaml_content: yamlContent,
                        testcases: currentTestCases,
                        is_debug: true  // é»˜è®¤ä½¿ç”¨è°ƒè¯•æ¨¡å¼
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // æ˜¾ç¤ºæ‰§è¡ŒæˆåŠŸä¿¡æ¯
                    const executionResult = document.getElementById('executionResult');
                    const executionTime = document.getElementById('executionTime');
                    const svnRevision = document.getElementById('svnRevision');
                    const testcaseCount = document.getElementById('testcaseCount');
                    const executionWarning = document.getElementById('executionWarning');
                    const executionWarningText = document.getElementById('executionWarningText');
                    
                    if (executionResult && executionTime && svnRevision && testcaseCount) {
                        executionTime.textContent = data.execution_time || new Date().toLocaleString('zh-CN');
                        svnRevision.textContent = data.svn_revision || 'å¾…é…ç½®';
                        testcaseCount.textContent = data.testcase_count || currentTestCases.length;
                        
                        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (data.warning) {
                            executionWarning.style.display = 'block';
                            executionWarningText.textContent = data.warning;
                        } else {
                            executionWarning.style.display = 'none';
                        }
                        
                        executionResult.style.display = 'block';
                        
                        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                        executionResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    
                    // ä¿å­˜æ„å»ºå·å’Œè°ƒè¯•æ¨¡å¼
                    if (data.build_number) {
                        currentBuildNumber = data.build_number;
                        
                        // æ·»åŠ æ‰§è¡Œæ­¥éª¤
                        addExecutionStep('ç”¨ä¾‹ä¸Šä¼ æˆåŠŸ', 'success');
                        addExecutionStep('å¼€å§‹æ‰§è¡Œç”¨ä¾‹...', 'success');
                        addExecutionStep(`Jenkinsæ„å»º #${data.build_number} å·²è§¦å‘`, 'success');
                        addExecutionStep('ç­‰å¾…Jenkinsæ„å»ºå®Œæˆ...', 'running');
                        
                        // å¼€å§‹è½®è¯¢Jenkinsæ„å»ºçŠ¶æ€
                        const jobName = data.is_debug ? 'AI-jk-debug' : 'AI-jk';
                        pollJenkinsBuildStatus(jobName, data.build_number);
                    }
                    
                    showSuccess('âœ… æµ‹è¯•ç”¨ä¾‹æ‰§è¡ŒæˆåŠŸï¼');
                } else {
                    showError('æ‰§è¡Œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('æ‰§è¡Œå¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
        async function viewTestReport() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºå·
                if (!currentBuildNumber) {
                    showError('âš ï¸ è¯·å…ˆæ‰§è¡Œç”¨ä¾‹ä»¥è·å–æ„å»ºå·');
                    return;
                }
                
                // ä½¿ç”¨æ„å»ºå·è·å–æŠ¥å‘ŠURL
                const response = await fetch(`/api/get-report-url?build_number=${currentBuildNumber}&is_debug=${currentIsDebug}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æŠ¥å‘Š
                    window.open(data.report_url, '_blank');
                    showSuccess('æ­£åœ¨æ‰“å¼€æµ‹è¯•æŠ¥å‘Š...');
                } else {
                    showError('âš ï¸ ' + (data.error || 'æµ‹è¯•æŠ¥å‘Šåœ°å€æœªé…ç½®') + '\n\nè¯·åœ¨.envæ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š\n- TEST_REPORT_URL: æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€\n- TEST_REPORT_DEBUG_URL: è°ƒè¯•æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€');
                }
            } catch (error) {
                showError('è·å–æŠ¥å‘Šåœ°å€å¤±è´¥: ' + error.message);
            }
        }

        async function generateOrViewPython() {
            // å¦‚æœå·²ç»æœ‰ç”Ÿæˆçš„Pythonä»£ç ï¼Œç›´æ¥å±•ç¤º
            if (currentPythonCode) {
                showPythonEditor(currentPythonCode);
                return;
            }
            
            // å¦åˆ™è°ƒç”¨Difyæ¥å£ç”ŸæˆPythonè„šæœ¬
            await generatePythonScript();
        }

        async function generatePythonScript() {
            if (currentTestCases.length === 0) {
                showError('æ²¡æœ‰æµ‹è¯•ç”¨ä¾‹æ•°æ®ï¼Œæ— æ³•ç”ŸæˆPythonè„šæœ¬');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨ç”ŸæˆPythonè„šæœ¬ï¼ˆä½¿ç”¨YAMLæ–‡ä»¶ä¸Šä¼ æ–¹å¼ï¼‰...');
                
                // è°ƒç”¨æ–°çš„YAMLæ–‡ä»¶ä¸Šä¼ API
                const response = await fetch('/api/generate-python-yaml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        collection_id: currentCollectionId,
                        interface_id: currentInterfaceId,
                        user_id: 'user_' + Date.now()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentPythonCode = data.python_code;
                    showPythonEditor(data.python_code, true, '');
                    showSuccess('âœ… Pythonè„šæœ¬ç”ŸæˆæˆåŠŸï¼');
                } else {
                    showError('ç”ŸæˆPythonè„šæœ¬å¤±è´¥: ' + (data.error || 'æœåŠ¡å™¨é”™è¯¯'));
                }
            } catch (error) {
                showError('ç”ŸæˆPythonè„šæœ¬å¤±è´¥: ' + error.message);
            }
        }

        function showPythonEditor(pythonCode, syntaxValid = true, syntaxError = '') {
            const editorHTML = `
                <div id="pythonEditorModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 900px; max-height: 80%; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #333;">ğŸ Pythonæµ‹è¯•è„šæœ¬</h3>
                            <button onclick="closePythonEditor()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ• å…³é—­</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-small" onclick="regeneratePython()" style="background: #28a745; margin-right: 10px;">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                            <button class="btn btn-small" onclick="savePython()" style="background: #17a2b8;">ğŸ’¾ ä¿å­˜ä»£ç </button>
                            <button class="btn btn-small" onclick="downloadPython()" style="background: #6c757d;">ğŸ“¥ ä¸‹è½½Pythonæ–‡ä»¶</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            ${syntaxValid ? 
                                '<span style="color: #28a745; font-weight: bold;">âœ… è¯­æ³•éªŒè¯é€šè¿‡</span>' : 
                                `<span style="color: #dc3545; font-weight: bold;">âŒ è¯­æ³•é”™è¯¯: ${syntaxError || 'æœªçŸ¥é”™è¯¯'}</span>`
                            }
                        </div>
                        <textarea id="pythonEditor" style="width: 100%; height: 400px; font-family: 'Courier New', monospace; font-size: 14px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${pythonCode}</textarea>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥ç¼–è¾‘Pythonä»£ç ï¼Œç¡®ä¿è¯­æ³•æ­£ç¡®åä¿å­˜æˆ–ä¸‹è½½
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„ç¼–è¾‘å™¨
            const existingModal = document.getElementById('pythonEditorModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', editorHTML);
        }

        function closePythonEditor() {
            const modal = document.getElementById('pythonEditorModal');
            if (modal) {
                modal.remove();
            }
        }

        async function regeneratePython() {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”ŸæˆPythonè„šæœ¬å—ï¼Ÿå½“å‰ç¼–è¾‘çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) {
                return;
            }
            
            await generatePythonScript();
        }

        function savePython() {
            const editor = document.getElementById('pythonEditor');
            if (editor) {
                currentPythonCode = editor.value;
                showSuccess('âœ… Pythonä»£ç å·²ä¿å­˜åˆ°å†…å­˜');
            }
        }

        async function downloadPython() {
            const editor = document.getElementById('pythonEditor');
            if (!editor) {
                showError('æ‰¾ä¸åˆ°Pythonç¼–è¾‘å™¨');
                return;
            }
            
            const pythonCode = editor.value;
            
            try {
                const response = await fetch('/api/download-python', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        python_code: pythonCode
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `test_script_${currentInterfaceId}_${new Date().getTime()}.py`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('âœ… Pythonæ–‡ä»¶ä¸‹è½½æˆåŠŸ');
                } else {
                    const errorData = await response.json();
                    showError('ä¸‹è½½Pythonæ–‡ä»¶å¤±è´¥: ' + (errorData.error || 'æœåŠ¡å™¨é”™è¯¯'));
                }
            } catch (error) {
                showError('ä¸‹è½½Pythonæ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        function showLoading(message) {
            const alert = document.getElementById('alert');
            alert.innerHTML = `<div class="alert alert-success">${message}</div>`;
        }
        
        function hideLoading() {
            const alert = document.getElementById('alert');
            alert.innerHTML = '';
        }
        
        function closeExecutionResult() {
            const executionResult = document.getElementById('executionResult');
            if (executionResult) {
                executionResult.style.display = 'none';
            }
        }

        function convertToYAML(testCases) {
            if (testCases.length === 0) return '';
            
            const yamlLines = [
                '# æµ‹è¯•ç”¨ä¾‹ YAML æ ¼å¼æ–‡ä»¶',
                '# ç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString(),
                '# æµ‹è¯•ç”¨ä¾‹æ•°é‡: ' + testCases.length,
                'test_cases:'
            ];
            
            testCases.forEach((testCase, index) => {
                yamlLines.push(`  - test_case_id: "${testCase.test_case_id || `TC${String(index + 1).padStart(3, '0')}`}"`);
                yamlLines.push(`    test_case_name: "${testCase.test_case_name || `æµ‹è¯•ç”¨ä¾‹ ${index + 1}`}"`);
                yamlLines.push(`    api_name: "${testCase.api_name || ''}"`);
                yamlLines.push(`    method: "${testCase.method || 'GET'}"`);
                yamlLines.push(`    url: "${testCase.url || ''}"`);
                
                // å¤„ç† headers å­—æ®µï¼Œä½¿ç”¨ JSON å¯¹è±¡æ ¼å¼
                if (testCase.headers && typeof testCase.headers === 'string' && testCase.headers.trim()) {
                    try {
                        const headersObj = JSON.parse(testCase.headers);
                        yamlLines.push(`    headers:`);
                        Object.keys(headersObj).forEach(key => {
                            yamlLines.push(`      ${key}: "${headersObj[key]}"`);
                        });
                    } catch (e) {
                        yamlLines.push(`    headers: "${testCase.headers}"`);
                    }
                } else if (testCase.headers && typeof testCase.headers === 'object') {
                    yamlLines.push(`    headers:`);
                    Object.keys(testCase.headers).forEach(key => {
                        yamlLines.push(`      ${key}: "${testCase.headers[key]}"`);
                    });
                } else {
                    yamlLines.push(`    headers: {}`);
                }
                
                // å¤„ç† request_data å­—æ®µï¼Œä½¿ç”¨ JSON å¯¹è±¡æ ¼å¼
                if (testCase.request_data && typeof testCase.request_data === 'string' && testCase.request_data.trim()) {
                    try {
                        const requestDataObj = JSON.parse(testCase.request_data);
                        yamlLines.push(`    request_data:`);
                        Object.keys(requestDataObj).forEach(key => {
                            const value = requestDataObj[key];
                            if (typeof value === 'object') {
                                yamlLines.push(`      ${key}: ${JSON.stringify(value)}`);
                            } else {
                                yamlLines.push(`      ${key}: "${value}"`);
                            }
                        });
                    } catch (e) {
                        yamlLines.push(`    request_data: "${testCase.request_data}"`);
                    }
                } else if (testCase.request_data && typeof testCase.request_data === 'object') {
                    yamlLines.push(`    request_data:`);
                    Object.keys(testCase.request_data).forEach(key => {
                        const value = testCase.request_data[key];
                        if (typeof value === 'object') {
                            yamlLines.push(`      ${key}: ${JSON.stringify(value)}`);
                        } else {
                            yamlLines.push(`      ${key}: "${value}"`);
                        }
                    });
                } else {
                    yamlLines.push(`    request_data: {}`);
                }
                
                yamlLines.push(`    expected_status_code: ${testCase.expected_status_code || 200}`);
                
                // å¤„ç† expected_response å­—æ®µï¼Œä½¿ç”¨ JSON å¯¹è±¡æ ¼å¼
                if (testCase.expected_response && typeof testCase.expected_response === 'string' && testCase.expected_response.trim()) {
                    try {
                        const responseObj = JSON.parse(testCase.expected_response);
                        yamlLines.push(`    expected_response:`);
                        Object.keys(responseObj).forEach(key => {
                            const value = responseObj[key];
                            if (typeof value === 'object') {
                                yamlLines.push(`      ${key}: ${JSON.stringify(value)}`);
                            } else {
                                yamlLines.push(`      ${key}: "${value}"`);
                            }
                        });
                    } catch (e) {
                        yamlLines.push(`    expected_response: "${testCase.expected_response}"`);
                    }
                } else if (testCase.expected_response && typeof testCase.expected_response === 'object') {
                    yamlLines.push(`    expected_response:`);
                    Object.keys(testCase.expected_response).forEach(key => {
                        const value = testCase.expected_response[key];
                        if (typeof value === 'object') {
                            yamlLines.push(`      ${key}: ${JSON.stringify(value)}`);
                        } else {
                            yamlLines.push(`      ${key}: "${value}"`);
                        }
                    });
                } else {
                    yamlLines.push(`    expected_response: {}`);
                }
                
                yamlLines.push(`    test_type: "${testCase.test_type || 'positive'}"`);
                yamlLines.push(`    priority: "${testCase.priority || 'medium'}"`);
                yamlLines.push(`    description: "${testCase.description || ''}"`);
                yamlLines.push(`    preconditions: "${testCase.preconditions || ''}"`);
                yamlLines.push(`    postconditions: "${testCase.postconditions || ''}"`);
                
                // å¤„ç† tags å­—æ®µï¼Œä½¿ç”¨æ•°ç»„æ ¼å¼
                if (testCase.tags && typeof testCase.tags === 'string' && testCase.tags.trim()) {
                    try {
                        const tagsArray = JSON.parse(testCase.tags);
                        if (Array.isArray(tagsArray)) {
                            yamlLines.push(`    tags:`);
                            tagsArray.forEach(tag => {
                                yamlLines.push(`      - "${tag}"`);
                            });
                        } else {
                            yamlLines.push(`    tags: ["${testCase.tags}"]`);
                        }
                    } catch (e) {
                        yamlLines.push(`    tags: ["${testCase.tags}"]`);
                    }
                } else if (testCase.tags && Array.isArray(testCase.tags)) {
                    yamlLines.push(`    tags:`);
                    testCase.tags.forEach(tag => {
                        yamlLines.push(`      - "${tag}"`);
                    });
                } else {
                    yamlLines.push(`    tags: []`);
                }
                
                yamlLines.push(''); // ç©ºè¡Œåˆ†éš”æµ‹è¯•ç”¨ä¾‹
            });
            
            return yamlLines.join('\n');
        }



        function filterTestCases() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = currentTestCases.filter(testCase => 
                Object.values(testCase).some(value => 
                    String(value).toLowerCase().includes(searchTerm)
                )
            );
            
            // ä¸´æ—¶æ˜¾ç¤ºè¿‡æ»¤ç»“æœ
            const tempTestCases = currentTestCases;
            currentTestCases = filtered;
            displayTestCases();
            currentTestCases = tempTestCases;
        }

        function showSuccess(message) {
            console.log('æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯:', message);
            const alert = document.getElementById('alert');
            if (!alert) {
                console.error('æ‰¾ä¸åˆ°alertå…ƒç´ ');
                return;
            }
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾ï¼Œä¿æŒæ ¼å¼
            const formattedMessage = message.replace(/\n/g, '<br>');
            alert.innerHTML = `<div class="alert alert-success" style="white-space: pre-wrap; text-align: left; line-height: 1.6;">${formattedMessage}</div>`;
            // æ»šåŠ¨åˆ°æç¤ºåŒºåŸŸ
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // æˆåŠŸæ¶ˆæ¯10ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => alert.innerHTML = '', 10000);
        }

        function showError(message) {
            console.log('æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯:', message);
            const alert = document.getElementById('alert');
            if (!alert) {
                console.error('æ‰¾ä¸åˆ°alertå…ƒç´ ');
                return;
            }
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾ï¼Œä¿æŒæ ¼å¼
            const formattedMessage = message.replace(/\n/g, '<br>');
            alert.innerHTML = `<div class="alert alert-error" style="white-space: pre-wrap; text-align: left; line-height: 1.6;">${formattedMessage}</div>`;
            // æ»šåŠ¨åˆ°æç¤ºåŒºåŸŸ
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function addExecutionStep(message, status = 'running') {
            const stepList = document.getElementById('stepList');
            const executionSteps = document.getElementById('executionSteps');
            
            if (stepList && executionSteps) {
                executionSteps.style.display = 'block';
                
                const stepDiv = document.createElement('div');
                stepDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; font-size: 0.9em;';
                
                let icon = '';
                let color = '';
                if (status === 'running') {
                    icon = 'â³';
                    color = '#666';
                } else if (status === 'success') {
                    icon = 'âœ…';
                    color = '#28a745';
                } else if (status === 'error') {
                    icon = 'âŒ';
                    color = '#dc3545';
                }
                
                stepDiv.innerHTML = `<span style="font-size: 1.2em;">${icon}</span><span style="color: ${color};">${message}</span>`;
                stepList.appendChild(stepDiv);
            }
        }
        
        function clearExecutionSteps() {
            const stepList = document.getElementById('stepList');
            if (stepList) {
                stepList.innerHTML = '';
            }
        }
        
        async function pollJenkinsBuildStatus(jobName, buildNumber) {
            let pollCount = 0;
            const maxPolls = 120; // æœ€å¤šè½®è¯¢10åˆ†é’Ÿï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
            
            const pollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch(`/api/get-build-status?job_name=${jobName}&build_number=${buildNumber}`);
                    const result = await response.json();
                    
                    if (result.success && result.build_info) {
                        const status = result.build_info.status;
                        const building = result.build_info.building;
                        
                        if (!building && status !== 'BUILDING') {
                            clearInterval(pollInterval);
                            
                            if (status === 'SUCCESS') {
                                addExecutionStep('Jenkinsæ„å»ºå®Œæˆï¼Œæµ‹è¯•æ‰§è¡ŒæˆåŠŸ', 'success');
                                enableViewReportButton();
                            } else if (status === 'FAILURE') {
                                addExecutionStep('Jenkinsæ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—', 'error');
                                enableViewReportButton(); // å³ä½¿å¤±è´¥ä¹Ÿå…è®¸æŸ¥çœ‹æŠ¥å‘Š
                            } else {
                                addExecutionStep(`Jenkinsæ„å»ºç»“æŸï¼ŒçŠ¶æ€: ${status}`, 'success');
                                enableViewReportButton();
                            }
                        }
                    }
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        addExecutionStep('æ„å»ºçŠ¶æ€æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°', 'error');
                        enableViewReportButton(); // è¶…æ—¶ä¹Ÿå…è®¸æŸ¥çœ‹æŠ¥å‘Š
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢æ„å»ºçŠ¶æ€å¤±è´¥:', error);
                }
            }, 5000); // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡
        }
        
        function enableViewReportButton() {
            const viewReportBtn = document.getElementById('viewReportBtn');
            if (viewReportBtn) {
                viewReportBtn.disabled = false;
                viewReportBtn.style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
                viewReportBtn.style.cursor = 'pointer';
            }
        }
        
        function disableViewReportButton() {
            const viewReportBtn = document.getElementById('viewReportBtn');
            if (viewReportBtn) {
                viewReportBtn.disabled = true;
                viewReportBtn.style.background = '#ccc';
                viewReportBtn.style.cursor = 'not-allowed';
            }
        }

        async function archiveTestCase() {
            if (!currentCollectionId || !currentInterfaceId) {
                showError('ç¼ºå°‘é›†åˆIDæˆ–æ¥å£ID');
                return;
            }
            
            if (currentTestCases.length === 0) {
                showError('æ²¡æœ‰æµ‹è¯•ç”¨ä¾‹å¯å½’æ¡£');
                return;
            }
            
            const confirmMessage = `
ğŸ“¦ ç¡®å®šè¦å°†å½“å‰ç”¨ä¾‹å½’æ¡£åˆ°æ­£å¼ç¯å¢ƒå—ï¼Ÿ

ğŸ“Š å½’æ¡£ä¿¡æ¯ï¼š
   â€¢ ç”¨ä¾‹æ•°é‡ï¼š${currentTestCases.length} ä¸ª
   â€¢ é›†åˆIDï¼š${currentCollectionId}
   â€¢ æ¥å£IDï¼š${currentInterfaceId}

ğŸ“ ç›®æ ‡SVNè·¯å¾„ï¼š
   svn://172.16.9.XXX/repo/jiaoben/jk/data_yaml

âš ï¸ æ³¨æ„ï¼šå½’æ¡£åï¼Œè¯¥ç”¨ä¾‹å°†ç”¨äºæ­£å¼æµ‹è¯•æ‰§è¡Œï¼
            `.trim();
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨å½’æ¡£ç”¨ä¾‹...');
                
                // å°†æµ‹è¯•ç”¨ä¾‹è½¬æ¢ä¸ºYAMLæ ¼å¼ï¼ˆä¸æ‰§è¡Œç”¨ä¾‹ç›¸åŒçš„æ–¹å¼ï¼‰
                const yamlContent = convertToYAML(currentTestCases);
                
                if (!yamlContent) {
                    showError('æ— æ³•ç”ŸæˆYAMLå†…å®¹ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸ºç©º');
                    return;
                }
                
                const response = await fetch('/api/archive-testcase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        collection_id: currentCollectionId,
                        interface_id: currentInterfaceId,
                        yaml_content: yamlContent,
                        testcases: currentTestCases
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ„å»ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
                    const successMessage = `
ğŸ‰ ç”¨ä¾‹å½’æ¡£æˆåŠŸï¼

ğŸ“¦ å½’æ¡£ä¿¡æ¯ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“„ æ–‡ä»¶åç§°ï¼š${data.filename}
ğŸ”– SVNç‰ˆæœ¬ï¼šr${data.revision}
ğŸ“ ç”¨ä¾‹æ•°é‡ï¼š${data.testcase_count || currentTestCases.length} ä¸ª
ğŸ“… å½’æ¡£æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}

ğŸ“ SVNè·¯å¾„ï¼š
   svn://172.16.9.XXX/repo/jiaoben/jk/data_yaml

âœ… è¯¥ç”¨ä¾‹å·²æäº¤åˆ°æ­£å¼ç¯å¢ƒï¼Œå¯ç”¨äºæ­£å¼æµ‹è¯•æ‰§è¡Œã€‚
                    `.trim();
                    
                    showSuccess(successMessage);
                    
                    // å¯é€‰ï¼š3ç§’åè‡ªåŠ¨å…³é—­æç¤º
                    // setTimeout(() => {
                    //     const alertDiv = document.getElementById('alert');
                    //     if (alertDiv) alertDiv.innerHTML = '';
                    // }, 5000);
                } else {
                    showError('âŒ å½’æ¡£å¤±è´¥\n\né”™è¯¯ä¿¡æ¯ï¼š' + data.error);
                }
            } catch (error) {
                showError('âŒ å½’æ¡£å¤±è´¥\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function executeProductionTestCases() {
            if (!currentCollectionId) {
                showError('ç¼ºå°‘é›†åˆID');
                return;
            }

            const confirmMessage = `
ğŸš€ ç¡®å®šè¦æ‰§è¡Œæ­£å¼ç¯å¢ƒçš„æ‰€æœ‰ç”¨ä¾‹å—ï¼Ÿ

ğŸ“Š æ‰§è¡Œä¿¡æ¯ï¼š
   â€¢ æ‰§è¡ŒèŒƒå›´ï¼šæ­£å¼SVNç›®å½•ä¸‹çš„æ‰€æœ‰ç”¨ä¾‹
   â€¢ SVNè·¯å¾„ï¼šsvn://172.16.9.XXX/repo/jiaoben/jk/data_yaml
   â€¢ Jenkins Jobï¼šAI-jkï¼ˆæ­£å¼ç¯å¢ƒï¼‰

âš ï¸ æ³¨æ„ï¼šè¿™å°†è§¦å‘æ­£å¼ç¯å¢ƒçš„å®Œæ•´æµ‹è¯•ï¼
            `.trim();

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoading('æ­£åœ¨è§¦å‘æ­£å¼ç”¨ä¾‹æ‰§è¡Œ...');

                const response = await fetch(`/api/execute-all-testcases/${currentCollectionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    const successMessage = `
ğŸ‰ æ­£å¼ç”¨ä¾‹æ‰§è¡Œå·²è§¦å‘ï¼

ğŸ“Š æ‰§è¡Œä¿¡æ¯ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—ï¸ Jenkins Jobï¼š${data.job_name}
ğŸ”¢ æ„å»ºå·ï¼š#${data.build_number}
ğŸ“… è§¦å‘æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}

ğŸ“ Jenkinsåœ°å€ï¼š
   http://172.16.9.XXX:8082/view/AI-jiekou/job/AI-jk/

âœ… æµ‹è¯•æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹æŠ¥å‘Šã€‚
                    `.trim();

                    showSuccess(successMessage);

                    // å¦‚æœæœ‰æŠ¥å‘ŠURLï¼Œå¯ä»¥å¯ç”¨æŸ¥çœ‹æŠ¥å‘ŠæŒ‰é’®
                    if (data.report_url) {
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€»è¾‘
                    }
                } else {
                    showError('âŒ è§¦å‘æ­£å¼ç”¨ä¾‹æ‰§è¡Œå¤±è´¥\n\né”™è¯¯ä¿¡æ¯ï¼š' + data.error);
                }
            } catch (error) {
                showError('âŒ è§¦å‘æ­£å¼ç”¨ä¾‹æ‰§è¡Œå¤±è´¥\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        function viewProductionReport() {
            // æ‰“å¼€æ€»æµ‹è¯•æŠ¥å‘Šé¡µé¢
            const reportUrl = 'http://172.16.9.XXX:8082/view/AI-jiekou/job/AI-jk/lastSuccessfulBuild/allure/';
            
            const confirmMessage = `
ğŸ“ˆ å³å°†æ‰“å¼€æ€»æµ‹è¯•æŠ¥å‘Š

ğŸ“ æŠ¥å‘Šåœ°å€ï¼š
   http://172.16.9.XXX:8082/view/AI-jiekou/job/AI-jk/

ğŸ’¡ æç¤ºï¼š
   â€¢ å°†æ‰“å¼€æœ€æ–°æˆåŠŸæ„å»ºçš„AllureæŠ¥å‘Š
   â€¢ å¦‚éœ€æŸ¥çœ‹ç‰¹å®šæ„å»ºï¼Œè¯·è®¿é—®Jenkinsé¡µé¢é€‰æ‹©

æ˜¯å¦ç»§ç»­ï¼Ÿ
            `.trim();

            if (confirm(confirmMessage)) {
                window.open(reportUrl, '_blank');
            }
        }

        function goBack() {
            // è¿”å›åˆ°å¯¹åº”é¡¹ç›®çš„æ¥å£åˆ—è¡¨é¡µ
            if (currentCollectionId) {
                // ç›´æ¥è·³è½¬åˆ°é¦–é¡µï¼Œå¹¶é€šè¿‡URLå‚æ•°è§¦å‘æ˜¾ç¤ºæ¥å£åˆ—è¡¨
                window.location.href = `/?show_collection=${currentCollectionId}`;
            } else if (window.history.length > 1) {
                // å¦‚æœæ²¡æœ‰collection_idï¼Œä½¿ç”¨æµè§ˆå™¨å†å²è®°å½•è¿”å›
                window.history.back();
            } else {
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œåˆ™è¿”å›åˆ°é¦–é¡µ
                window.location.href = '/';
            }
        }
    </script>
    <script src="{{ url_for('static', filename='theme-switcher.js') }}"></script>
</body>
</html>